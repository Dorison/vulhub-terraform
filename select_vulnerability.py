import requests
import json
import os
import subprocess

def get_vulhub_categories():
    url = "https://api.github.com/repos/vulhub/vulhub/contents"
    response = requests.get(url)
    if response.status_code != 200:
        print("âŒ I didn't get a list of categories.")
        exit(1)

    data = response.json()
    categories = [item['name'] for item in data if item['type'] == 'dir']
    return categories

def get_vulnerabilities(category):
    url = f"https://api.github.com/repos/vulhub/vulhub/contents/{category}"
    response = requests.get(url)
    if response.status_code != 200:
        print("âŒ Failed to retrieve the list of vulnerabilities in the category.")
        exit(1)

    data = response.json()
    vulnerabilities = [item['name'] for item in data if item['type'] == 'dir']
    return vulnerabilities

def update_user_data(full_path):
    user_data_file = "user_data.sh"

    if not os.path.exists(user_data_file):
        print(f"âŒ File {user_data_file} not found")
        exit(1)

    # Ğ—Ñ‡Ğ¸Ñ‚Ğ°Ñ‚Ğ¸ Ğ²Ğ¼Ñ–ÑÑ‚
    with open(user_data_file, "r") as file:
        lines = file.readlines()

    # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº
    new_lines = []
    for line in lines:
        if line.strip().startswith("cd /opt/vulhub/"):
            new_lines.append(f"cd /opt/vulhub/{full_path}\n")
        else:
            new_lines.append(line)

    # Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´
    with open(user_data_file, "w") as file:
        file.writelines(new_lines)

    print(f"âœ… Update user_data.sh to vulnurability /opt/vulhub/{full_path}")

def run_terraform():
    print("\nğŸš€ Start terraform apply\n")
    subprocess.run(["terraform", "apply"])

def main():
    print("â¬‡ï¸ Download list of category Vulhub...")
    categories = get_vulhub_categories()

    print("\nğŸ” Available categories:")
    for idx, cat in enumerate(categories, 1):
        print(f"{idx}) {cat}")

    cat_choice = int(input("\nEnter number of category: ")) - 1
    selected_category = categories[cat_choice]

    print(f"\nâœ… You chose category: {selected_category}")

    vulnerabilities = get_vulnerabilities(selected_category)

    print("\nğŸ” Available vulnurability:")
    for idx, vuln in enumerate(vulnerabilities, 1):
        print(f"{idx}) {vuln}")

    vuln_choice = int(input("\nEnter number of vulnurability: ")) - 1
    selected_vuln = vulnerabilities[vuln_choice]

    full_path = f"{selected_category}/{selected_vuln}"
    print(f"\nâœ… You chose vulnurability: {full_path}")

    update_user_data(full_path)

    input("\nPress Enter to terraform apply ...")

    run_terraform()

if __name__ == "__main__":
    main()
